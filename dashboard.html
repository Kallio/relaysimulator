<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Osuuksien leimaukset</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #plot { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="plot"></div>
  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const controls = [];
    const eventHistory = [];

    // osuus -> trace ja värit
    const legTraces = {};
    const legColors = {};
    const colorPalette = Plotly.d3.scale.category10(); // 10 eri väriä
    const drawnMassStarts = new Set(); // vältetään duplicate-viivat

    function getLegFromRunner(runnerId) {
      if (!runnerId) return "unknown";
      const parts = runnerId.split(":");
      if (parts.length > 1 && !isNaN(parts[parts.length-1])) {
        return "Leg " + parts[parts.length-1];
      }
      return "unknown";
    }

    function getTraceForLeg(leg) {
      if (!legTraces[leg]) {
        const color = colorPalette(Object.keys(legTraces).length);
        legColors[leg] = color;
        legTraces[leg] = {
          x: [],
          y: [],
          text: [],
          mode: 'markers',
          type: 'scatter',
          name: leg,
          marker: { color: color, size: 10 }
        };
        Plotly.addTraces('plot', legTraces[leg]);
      }
      return legTraces[leg];
    }

    // initial empty plot
    Plotly.newPlot('plot', [], {
      title: "Leimaukset osuuksittain",
      xaxis: { title: "Aika" },
      yaxis: { title: "Rastit", type: "category", categoryorder: "array", categoryarray: controls },
      legend: { orientation: "h" }
    });

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      // --- Mass-start event ---
      if (msg.type === 'mass_start' && msg.timestamp && !drawnMassStarts.has(msg.timestamp)) {
        const startTs = new Date(msg.timestamp);
        Plotly.addTraces('plot', {
          x: [startTs, startTs],
          y: [0, 1],
          mode: 'lines',
          line: { color: 'red', width: 2, dash: 'dash' },
          name: `Mass start ${msg.group || ''}`
        });
        drawnMassStarts.add(msg.timestamp);
      }

      // --- Normaalit leimaukset ---
      if (msg.type === 'update' && msg.stats.last) {
        const ev = msg.stats.last;
        const runner = ev.runner_id || "unknown";
        const control = ev.device_id || "unknown";
        const ts = ev.timestamp ? new Date(ev.timestamp) : new Date();

        eventHistory.push({ ts, control, runner });

        if (!controls.includes(control)) {
          controls.push(control);
          Plotly.relayout('plot', { 'yaxis.categoryarray': controls });
        }

        // punches ±5 min
        const windowStart = new Date(ts.getTime() - 5*60000);
        const windowEnd   = new Date(ts.getTime() + 5*60000);
        const punchesNearby = eventHistory.filter(e =>
          e.control === control &&
          e.ts >= windowStart && e.ts <= windowEnd
        ).length;

        const leg = getLegFromRunner(runner);
        const tooltip = `Osuus: ${leg}<br>Runner: ${runner}<br>${control}<br>${ts.toISOString()}<br>Leimauksia ±5min: ${punchesNearby}`;

        const trace = getTraceForLeg(leg);

        Plotly.extendTraces('plot', {
          x: [[ts]],
          y: [[control]],
          text: [[tooltip]]
        }, [Object.keys(legTraces).indexOf(leg)]);
      }
    };
  </script>
</body>
</html>
